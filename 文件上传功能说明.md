# 📄 文件上传功能说明 v2.0

## 🎯 重要更新

### 新增功能：文件上传验证

为了确保流水数据的真实性，系统现在**要求上传证明文件**，而不是简单输入金额。

## 🔒 为什么需要文件上传？

### 之前的问题（v1.x）
- ❌ 用户可以随意输入任何金额
- ❌ 没有任何验证机制  
- ❌ 容易造假，不可信
- ❌ 无法作为正式的信用验证依据

### 现在的方案（v2.0）
- ✅ 必须上传银行流水文件
- ✅ 必须上传流水真实性承诺书
- ✅ 文件保存到服务器，可追溯
- ✅ 提供法律层面的可信度
- ✅ 符合实际商业场景需求

## 📋 使用流程

### 1. 准备材料

#### 银行流水文件
- **格式**：PDF、PNG、JPG、JPEG
- **大小**：最大 10MB
- **内容**：企业银行账户的流水明细
  - 建议：近一年的完整流水
  - 包含：账户信息、交易明细、余额等

#### 承诺书
- **格式**：PDF、PNG、JPG、JPEG
- **大小**：最大 10MB
- **内容**：承诺所提供流水真实有效
  - 公司公章
  - 法人签字
  - 承诺日期
  - 法律责任声明

**承诺书模板示例：**
```
企业流水真实性承诺书

本公司（公司名称）郑重承诺：
1. 所提供的银行流水文件真实、完整、准确
2. 流水数据未经任何篡改或伪造
3. 如有虚假，愿承担一切法律责任

公司名称：_______________
法定代表人签字：_______________
公司公章：
日期：_______________
```

### 2. 操作步骤

#### 步骤1：创建/加入会话
```
1. 打开系统 http://localhost:5000
2. 选择"发起比较"或"加入比较"
3. 输入公司名称
```

#### 步骤2：上传文件
```
1. 点击"📄 银行流水文件"下的"📎 选择文件"
   - 选择您的银行流水PDF或图片
   - 系统会验证文件格式和大小

2. 点击"📝 流水真实性承诺书"下的"📎 选择文件"
   - 选择您签署的承诺书
   - 同样会验证文件

3. 查看文件名确认选择正确
```

#### 步骤3：输入金额
```
1. 在"年度流水金额"输入框输入金额
2. **重要**：金额必须与上传的银行流水一致
3. 系统会根据金额计算档次
```

#### 步骤4：提交
```
1. 点击"🔒 加密并提交"按钮
2. 系统会：
   - 首先上传文件到服务器
   - 显示上传进度
   - 验证文件格式
   - 然后提交承诺
3. 等待对方也完成相同操作
```

#### 步骤5：查看结果
```
1. 双方都提交后自动显示比较结果
2. 结果只显示档次级别，不显示具体金额
3. 文件保存在服务器，可供核验
```

## 🔐 安全机制

### 文件验证
1. **格式检查**：只接受 PDF、PNG、JPG、JPEG
2. **大小限制**：单个文件最大 10MB
3. **文件名安全化**：自动处理特殊字符
4. **唯一性**：文件名包含会话ID、角色、时间戳

### 数据保护
- 文件存储在服务器 `uploads/` 目录
- 文件名格式：`{session_id}_{role}_{type}_{timestamp}_{original_name}`
- 例如：`abc123_company_a_bank_20251128195030_statement.pdf`

### 防作弊
- 必须同时上传两个文件才能提交
- 后端验证文件是否已上传
- 文件与会话绑定，可追溯

## 📊 技术实现

### 后端 API

#### 文件上传接口
```http
POST /api/upload_files
Content-Type: multipart/form-data

表单数据：
- session_id: 会话ID
- role: company_a 或 company_b
- bank_statement: 银行流水文件
- commitment_letter: 承诺书文件

响应：
{
  "success": true,
  "message": "文件上传成功",
  "files": {
    "bank_statement": "文件名",
    "commitment_letter": "文件名"
  }
}
```

#### 提交承诺（已修改）
```http
POST /api/commit
Content-Type: application/json

{
  "session_id": "xxx",
  "role": "company_a",
  "amount": 5000000
}

新增验证：
- 检查是否已上传文件
- 如果未上传，返回 400 错误
```

### 前端实现

#### HTML结构
```html
<!-- 银行流水上传 -->
<input type="file" id="bank-file" accept=".pdf,.png,.jpg,.jpeg" />
<span id="bank-file-name">未选择文件</span>

<!-- 承诺书上传 -->
<input type="file" id="commitment-file" accept=".pdf,.png,.jpg,.jpeg" />
<span id="commitment-file-name">未选择文件</span>

<!-- 上传进度 -->
<div class="upload-status">
  <div class="progress-bar"></div>
  <p>上传消息</p>
</div>
```

#### JavaScript逻辑
```javascript
// 文件选择
function handleFileSelect(type) {
  // 验证文件大小、格式
  // 更新UI显示
  // 保存到状态
}

// 文件上传
async function uploadFiles() {
  const formData = new FormData();
  formData.append('bank_statement', bankFile);
  formData.append('commitment_letter', commitmentFile);
  
  // 发送到服务器
  // 显示进度
  // 处理响应
}
```

## 🎨 UI改进

### 文件上传区域
- 虚线边框，拖拽友好的视觉设计
- 文件选择后边框变绿
- 显示选中的文件名
- 上传进度条

### 状态提示
- "未选择文件" → 灰色
- "文件名.pdf" → 绿色加粗
- "✅ 文件上传成功" → 成功提示
- "❌ 上传失败" → 错误提示

## ⚠️ 注意事项

### 1. 文件准备
- 确保银行流水清晰可读
- 承诺书必须有公章和签字
- 文件大小不超过 10MB
- 建议使用 PDF 格式

### 2. 金额一致性
- 输入的金额必须与流水一致
- 系统会保存文件供后续核验
- 虚假申报将承担法律责任

### 3. 隐私保护
- 文件仅用于此次比较
- 建议比较完成后删除敏感信息
- 生产环境应加密存储

### 4. 文件管理
- 开发环境文件存储在 `uploads/` 目录
- 建议定期清理过期文件
- 生产环境应使用对象存储（OSS等）

## 🚀 后续优化方向

### v2.1 计划
- [ ] OCR 自动识别流水金额
- [ ] 文件加密存储
- [ ] 文件自动过期删除
- [ ] 支持更多文件格式

### v2.2 计划
- [ ] 对接第三方银行API验证
- [ ] 区块链存证
- [ ] 电子签名验证
- [ ] 审计日志

## 🐛 故障排除

### 问题1：文件上传失败

**可能原因：**
- 文件太大（超过10MB）
- 文件格式不支持
- 网络问题

**解决方法：**
1. 压缩文件或转换格式
2. 检查网络连接
3. 查看浏览器Console错误信息

### 问题2："请先上传文件"提示

**原因：** 点击提交前未上传文件

**解决：**
1. 确保两个文件都已选择
2. 文件名显示为绿色
3. 看到"✅ 文件上传成功"提示后再提交

### 问题3：上传后无法提交

**检查：**
```javascript
// 在Console输入
console.log(currentState);
// 查看 filesUploaded 是否为 true
// bankFile 和 commitmentFile 是否有值
```

## 📞 技术支持

如有问题：
1. 查看浏览器 Console（F12）
2. 查看服务器终端日志
3. 检查 `uploads/` 目录是否创建
4. 确认文件权限正确

---

**版本：** v2.0  
**更新日期：** 2025-11-28  
**重要性：** ⚠️ 破坏性更新 - 必须上传文件才能使用

**现在系统更安全、更可信！** 🎉


